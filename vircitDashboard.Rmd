---
title: "Virtual Citizens and the Construction of Publicness"
resource_files:
- tabel_output.csv
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    favicon: logo-ugm.png
    orientation: columns
    theme: yeti
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(ggplot2)
library(plotly)
library(networkD3)
library(shiny)
library(textclean)
library(scales)
library(Rcpp)
library(dichromat)
library(plotly)
library(DT)
library(dygraphs)
library(lubridate)
library(reshape2)
library(repmis) # downloading Rdata from github
```

```{r global, include=FALSE, warning=FALSE, message=FALSE}
# data ----
# data 1
tabelOutput <- read.csv("https://raw.githubusercontent.com/eppofahmi/vircit-dachboard/master/data/tabelOutput.csv", stringsAsFactors = FALSE, header = TRUE, sep = ",")

# data 2
analisis_data <- read.csv("https://raw.githubusercontent.com/eppofahmi/vircit-dachboard/master/data/analisis_data.csv", stringsAsFactors = FALSE, header = TRUE, sep = ",")

# analysis data ----
daftar_sumber <- analisis_data %>%
  select(sumber_data) %>%
  count(sumber_data) %>%
  select(sumber_data)
analisis_data$sumber_data <- gsub("\\bpetisi_gojek\\b", "petisi", analisis_data$sumber_data)

# sumberdata -----
daftarTable_change <- tabelOutput %>%
  filter(kasus == "change") %>%
  select(sumber_data) %>%
  group_by(sumber_data) %>%
  count(sumber_data) %>%
  select(sumber_data)

daftarTable_gojek <- tabelOutput %>%
  filter(kasus == "gojek") %>%
  select(sumber_data) %>%
  group_by(sumber_data) %>%
  count(sumber_data) %>%
  select(sumber_data)

# close reading -----
# parameter
parameter_change <- tabelOutput %>% 
  filter(kasus == "change") %>%
  select(parameter) %>%
  count(parameter) %>%
  dplyr::select(parameter)

parameter_gojek <- tabelOutput %>% 
  filter(kasus == "gojek") %>%
  select(parameter) %>%
  count(parameter) %>%
  dplyr::select(parameter)

# keterangan ----
keterangan_change <- tabelOutput %>%
  filter(kasus == "change") %>%
  group_by(kasus, sumber_data) %>%
  count(parameter) %>%
  select(kasus, sumber_data, parameter, observasi = n)

keterangan_gojek <- tabelOutput %>%
  filter(kasus == "gojek") %>%
  group_by(kasus, sumber_data) %>%
  count(parameter) %>%
  select(kasus, sumber_data, parameter, observasi = n)

# timeseries data -----
# timeseries change ----
ts_change <- tabelOutput %>%
  filter(kasus == "change") %>%
  filter(sumber_data == "twitter") %>%
  select(tanggal, kasus, parameter) %>%
  group_by(tanggal, kasus) %>%
  count(parameter)
ts_change$tanggal <- as.POSIXlt.character(ts_change$tanggal)
ts_change <- ts_change %>%
  as.data.frame() %>%
  select(tanggal, parameter, n)
# create long data format from wide with n as the value
ts_change <- dcast(ts_change, tanggal ~ parameter)
# create timeseries data format 
ts_change <- timeSeries::as.timeSeries(ts_change)

# Timeseries gojek ----
ts_gojek <- tabelOutput %>%
  filter(kasus == "gojek") %>%
  filter(sumber_data == "twitter") %>%
  select(tanggal, kasus, parameter) %>%
  group_by(tanggal, kasus) %>%
  count(parameter)
ts_gojek$tanggal <- as.POSIXlt.character(ts_gojek$tanggal)
ts_gojek <- ts_gojek %>%
  as.data.frame() %>%
  select(tanggal, parameter, n)
# create long data format from wide with n as the value
ts_gojek <- dcast(ts_gojek, tanggal ~ parameter)
# create timeseries data format 
ts_gojek <- timeSeries::as.timeSeries(ts_gojek)

# Network analysis sampel ----
# data etwork ----
links_1 <- read.csv("https://raw.githubusercontent.com/eppofahmi/vircit-dashboard/master/data/links_gojek.csv", stringsAsFactors = FALSE, header = TRUE, sep = ",")
nodes_1 <- read.csv("https://raw.githubusercontent.com/eppofahmi/vircit-dashboard/master/data/nodes_gojek.csv", stringsAsFactors = FALSE, header = TRUE, sep = ",")

# click action 
# network vis ----
MyClickScript <- 'alert("You clicked " + d.name + " which is in row " + (d.index + 1) +  " of your original R data frame");'
```

Overview
=====================================

Column
-----------------------------------------------------------------------
### Data Sources

```{r, fig.width=8, fig.height=8}
ggplot(data = tabelOutput, aes(x = parameter, fill = sumber_data)) + 
  geom_bar(size = 0.2) + 
  theme_minimal(base_size = 12) + 
  theme(legend.position = "bottom") +
  scale_y_log10() + 
  geom_text(stat='count', aes(label=..count..), vjust = 0.5, 
            position = position_dodge(0.5)) +
  coord_polar(theta = "x", direction = 1) + 
  theme(axis.text.x = element_text(angle=-25)) +
  ggtitle("Observations/rows of each data source and parameters") +
  labs(x = NULL, y = NULL)
```

Column
-----------------------------------------------------------------------
### Tweets Change' Distribution

```{r}
# dygraph plot
dygraph(ts_change) %>%
  dySeries("balinotforsale", label = "#balinotforsale") %>%
  dySeries("balitolakreklamasi", label = "#balitolakreklamasi") %>%
  dySeries("to_@changeorg_id", label = "to_@changeorg_id") %>%
  dyOptions(stackedGraph = TRUE) %>%
  dyRangeSelector(height = 20)
```

### Tweets Gojek' Distribution

```{r}
# create plot
dygraph(ts_gojek) %>%
  dySeries("saveojekonline", label = "#saveojekonline") %>%
  dySeries("savegojek", label = "#savegojek") %>%
  dySeries("savedrivergojek", label = "#savedrivergojek") %>%
  dySeries("to_@ceritatranspol", label = "to_@ceritatranspol") %>%
  dyOptions(stackedGraph = TRUE) %>%
  dyRangeSelector(height = 20)
```

Topic Modelling {data-navmenu=Analytics}
===========================================

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
# input 1 - kasus
selectInput("kasus", label = "Pilih kasus:",
            choices = c("change",
                        "gojek"),
            selected = "gojek")

# input 3 - nomor topik
sliderInput("num_topic", label = "Topik ke-:",
            min = 1, max = 10, value = 1, step = 1)

# input 4 - jumlah term/bigram
sliderInput("bigram", label = "Jumlah term/bigram:",
            min = 5, max = 15, value = 10, step = 1)
```

Column
-----------------------------------------------------------------------
### Twitter
```{r tmTwitter}
shiny::renderPlot(analisis_data %>%
                     filter(kasus == input$kasus) %>%
                     filter(sumber_data == "twitter") %>%
                     select(topic, term, beta) %>%
                     filter(topic == as.numeric(input$num_topic)) %>%
                     group_by(topic) %>%
                     top_n(as.numeric(input$bigram)) %>%
                    ggplot(aes(reorder(term, beta), as.double(beta), fill = topic)) +
                    geom_col(show.legend = FALSE) + coord_flip() +
                    labs(x = NULL, y = "beta")
                   )
```

### Petisi
```{r}
shiny::renderPlot(analisis_data %>%
                     filter(kasus == input$kasus) %>%
                     filter(sumber_data == "petisi") %>%
                     select(topic, term, beta) %>%
                     filter(topic == as.numeric(input$num_topic)) %>%
                     group_by(topic) %>%
                     top_n(as.numeric(input$bigram)) %>%
                    ggplot(aes(reorder(term, beta), as.double(beta), fill = topic)) +
                    geom_col(show.legend = FALSE) + coord_flip() +
                    labs(x = NULL, y = "beta")
                   )
```


Column
-----------------------------------------------------------------------

### Playstore Customer
```{r}
shiny::renderPlot(analisis_data %>%
                     filter(kasus == input$kasus) %>%
                     filter(sumber_data == "playsotore_customer") %>%
                     select(topic, term, beta) %>%
                     filter(topic == as.numeric(input$num_topic)) %>%
                     group_by(topic) %>%
                     top_n(as.numeric(input$bigram)) %>%
                    ggplot(aes(reorder(term, beta), as.double(beta), fill = topic)) +
                    geom_col(show.legend = FALSE) + coord_flip() +
                    labs(x = NULL, y = "beta")
                   )
```

### Playstore Driver
```{r}
shiny::renderPlot(analisis_data %>%
                     filter(kasus == input$kasus) %>%
                     filter(sumber_data == "playsotore_driver") %>%
                     select(topic, term, beta) %>%
                     filter(topic == as.numeric(input$num_topic)) %>%
                     group_by(topic) %>%
                     top_n(as.numeric(input$bigram)) %>%
                    ggplot(aes(reorder(term, beta), as.double(beta), fill = topic)) +
                    geom_col(show.legend = FALSE) + coord_flip() +
                    labs(x = NULL, y = "beta")
                   )
```

Semantic Network {data-navmenu=Analytics}
===========================================

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
# weight graph
sliderInput("bobot", "Minimum weight", 1, 
                  min = 1,
                  max = 35, 
                  step = 2)

# opacity graph
sliderInput("opacity", "Nodes opacity", 1, 
                  min = 0.1,
                  max = 1, 
                  step = .1)
```

Column 
-----------------------------------------------------------------------

```{r}
renderForceNetwork(
  forceNetwork(Links = links_1 %>% filter(Weight >= input$bobot), 
               Nodes = nodes_1, 
               Source = "Source",
               Target = "Target", 
               Value = "Weight",
               NodeID = "Label",
               Nodesize = "eigencentrality", 
               Group = "modularity_class",
               opacity = input$opacity, 
               fontSize = 15,
               height = 700, width = 500,
               opacityNoHover = TRUE,
               linkColour = "#666",
               charge = -30,
               fontFamily = "serif", linkDistance = 50,
               radiusCalculation = JS(" Math.sqrt(d.nodesize)+6"),
               colourScale = JS("d3.scaleOrdinal(d3.schemeCategory20);"),
               clickAction = MyClickScript,
               zoom = TRUE)
)
```


Change {data-navmenu=Readings}
=====================================

Column {.sidebar}
-----------------------------------------------------------------------
Sumber data change

```{r}
# Search text - ok
textAreaInput("deteksi", label = "Masukkan kata kunci yang ingin di cari:")

# sumber data
selectInput("sumberdata", label = "Sumber data", 
            choices = daftarTable_change$sumber_data, 
            selected = "online_media")

# parameter selection
selectInput("param", label = "Parameter pencarian", 
            choices = parameter_change$parameter, 
            selected = "tempo")

# jumlah observasi - ok
# sliderInput("numb_row", label = "Jumlah Observasi:",
#             min = 5, max = 100, value = 10, step = 5)
```

Column {.tabset .tabset-fade}
-----------------------------------------------------------------------
### Tabel

```{r}
DT::renderDataTable(
    DT::datatable(tabelOutput %>%
      dplyr::filter(kasus == "change") %>%
      dplyr::filter(sumber_data == input$sumberdata) %>%
      dplyr::filter(parameter == input$param) %>%
      filter(str_detect(teks_clean, input$deteksi)) %>%
      dplyr::select(tanggal, teks, parameter),
      options = list(searching = TRUE, 
                     lengthMenu = list(c(1,3,4,5,10,-1), c("1","3","4",'5','10','All'))))
  )
```

### Keterangan
Parameter = Judul Petisi:

1. petisi_change1 = Revoke the reclamation permit of Benoa gulf, immediately!
2. petisi_change2 = Segera Cabut SK Reklamasi Teluk Benoa
3. petisi_change3 = Pak @Jokowi, Segera Batalkan Perpres 51 Tahun 2014

```{r}
DT::renderDataTable(
    DT::datatable(keterangan_change, 
                  options = list(searching = TRUE, 
                                 lengthMenu = list(c(5, 10, -1), c('5', '10', 'All'))))
  )
```


Gojek {data-navmenu=Readings}
=====================================

Column {.sidebar}
-----------------------------------------------------------------------
Sumber data Gojek

```{r}
# Search text - ok
textAreaInput("detek", label = "Masukkan kata kunci yang ingin di cari:")

# sumber data
selectInput("sumber", label = "Sumber data", 
            choices = daftarTable_gojek$sumber_data, 
            selected = "online_media")

# parameter selection
selectInput("para", label = "Parameter pencarian", 
            choices = parameter_gojek$parameter, 
            selected = "tempo")

# jumlah observasi - ok
# sliderInput("numb", label = "Jumlah Observasi:",
#             min = 5, max = 100, value = 10, step = 5)
```

Column {.tabset .tabset-fade}
-----------------------------------------------------------------------
### Tabel

```{r}
DT::renderDataTable(
    DT::datatable(tabelOutput %>%
      dplyr::filter(kasus == "gojek") %>%
      dplyr::filter(sumber_data == input$sumber) %>%
      dplyr::filter(parameter == input$para) %>%
      filter(str_detect(teks_clean, input$detek)) %>%
      dplyr::select(tanggal, teks, parameter),
      options = list(searching = TRUE, 
                     lengthMenu = list(c(1,3,4,5,10,-1), c("1","3","4",'5','10','All'))))
  )
```


### Keterangan
Parameter = Judul Petisi:

1. petisi_gojek1 = Cabut larangan pengoperasian layanan transportasi berbasis online (Gojek, GrabBike,dll)
2. petisi_gojek2 = Dukung Keberadaan Go-Jek di Purwokerto
3. petisi_gojek3 = Hentikan Permenhub 108
4. petisi_gojek4 = Kami Membutuhkan Gojek
5. petisi_gojek5 = Jangan Kembali Renggut Kebebasan Masyarakat Jawa Barat Untuk Memilih Transportasi!
6. petisi_gojek6 = Tolak Pencabutan GoJek Tasikmalaya!

```{r}
DT::renderDataTable(
    DT::datatable(keterangan_gojek,
                  options = list(searching = TRUE, 
                                 lengthMenu = list(c(5, 10, -1), c('5', '10', 'All'))))
  )
```

